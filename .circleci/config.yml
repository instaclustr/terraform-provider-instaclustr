version: 2
jobs:
  build:
    docker:
      - image: circleci/golang:1.14
    working_directory: /go/src/github.com/arjunrajshekhar/terraform-provider-instaclustr
    steps:
      - checkout
      - run: go get -v -t -d ./...
      - run:
          name: "Build for Windows, Linux and OSX"
          command: |
            FULL_BIN_NAME="terraform-provider-instaclustr_${CIRCLE_TAG}"
            env GOOS=darwin GOARCH=amd64 make build BIN_NAME="terraform-provider-instaclustr" VERSION=${CIRCLE_TAG}
            zip -j bin/${FULL_BIN_NAME}_macOS_x64.zip bin/${FULL_BIN_NAME}
            env GOOS=linux GOARCH=amd64 make build BIN_NAME="terraform-provider-instaclustr" VERSION=${CIRCLE_TAG}
            zip -j bin/${FULL_BIN_NAME}_linux_x64.zip bin/${FULL_BIN_NAME}
            env GOOS=windows GOARCH=amd64 make build BIN_NAME="terraform-provider-instaclustr" VERSION=${CIRCLE_TAG}
            zip -j bin/${FULL_BIN_NAME}_windows_x64.zip bin/${FULL_BIN_NAME}
            env GOOS=windows GOARCH=386 make build BIN_NAME="terraform-provider-instaclustr" VERSION=${CIRCLE_TAG}
            zip -j bin/${FULL_BIN_NAME}_windows_x86.zip bin/${FULL_BIN_NAME}
            rm bin/${FULL_BIN_NAME}
      - run:
          name: "Publish Release on GitHub"
          command: |
            go get github.com/tcnksm/ghr
            ghr -t ${GITHUB_TOKEN} \
            -u ${CIRCLE_PROJECT_USERNAME} \
            -r ${CIRCLE_PROJECT_REPONAME} \
            -c ${CIRCLE_SHA1} \
            -delete \
            -n "Release ${CIRCLE_TAG}" \
            -b "Generated by Instaclustr's Circle CI account." \
            ${CIRCLE_TAG} ./bin/

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/